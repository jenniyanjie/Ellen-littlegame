<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ellen's Missing Letter</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#1f2d3d; --muted:#708090;
    --accent:#5c7cfa; --ok:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,Arial;}
  body{background:linear-gradient(180deg,#eef2ff, #f6f7fb);}
  .wrap{max-width:900px;margin:24px auto;padding:16px;}
  .game{background:var(--card);box-shadow:0 10px 30px rgba(21,24,79,.08);border-radius:16px;padding:20px;}
  h1{margin:8px 0 12px;font-size:24px;color:var(--ink)}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  select,button{border:1px solid #dce0f0;border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink);font-size:14px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border:none}
  button.good{background:var(--ok);color:#fff;border:none}
  button.bad{background:var(--bad);color:#fff;border:none}
  button.hint{background:#ffc107;color:#212529;border:none;font-weight:600}
  .status{margin-left:auto;color:var(--muted);font-size:13px}
  .card{margin:18px 0;padding:18px;border:1px dashed #e3e7ff;border-radius:12px;background:#fafbff}
  .word-display{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:2px solid #eef2ff}
  .word-speak-btn{padding:10px 16px;border:none;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:6px;transition:all 0.2s}
  .word-speak-btn:hover{background:#4c68d9;transform:scale(1.05)}
  .word-speak-btn:active{transform:scale(0.98)}
  .word-translation{color:var(--muted);font-size:16px;font-weight:500;background:#f8faff;padding:8px 12px;border-radius:6px;border:1px solid #e3e7ff}
  .mask{display:flex;gap:8px;flex-wrap:nowrap;justify-content:center;margin:12px 0;overflow-x:auto;padding:4px}
  .slot{width:48px;height:60px;border-radius:10px;background:#fff;display:grid;place-items:center;
        box-shadow:0 6px 14px rgba(0,0,0,.06);font-size:28px;font-weight:700;letter-spacing:1px;flex-shrink:0}
  .slot.hole{outline:2px dashed #c7d2fe; background:#f8faff;color:#9aa3b2}
  
  /* Mobile responsive design */
  @media (max-width: 768px) {
    .puzzle-container {
      flex-direction: column !important;
      gap: 12px !important;
      margin: 12px 0 !important;
      align-items: center !important;
    }
    
    .mask {
      width: 100%;
      max-width: calc(100vw - 40px);
      justify-content: center;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0 10px;
    }
    
    .mask::-webkit-scrollbar {
      display: none;
    }
    
    /* Ensure translation is centered when displayed */
    .word-translation {
      text-align: center;
      align-self: center;
    }
  }
  
  @media (max-width: 480px) {
    .slot {
      width: calc((100vw - 80px) / 8);
      min-width: 32px;
      max-width: 44px;
      height: 48px;
      font-size: 22px;
    }
    
    .word-translation {
      font-size: 14px;
      padding: 6px 10px;
    }
    
    .word-display {
      gap: 12px;
      margin: 12px 0;
      padding: 12px;
    }
    
    .word-speak-btn {
      padding: 8px 12px;
      font-size: 12px;
    }
  }
  .letters{display:grid;grid-template-columns:repeat(auto-fit,minmax(44px,1fr));gap:8px;margin-top:8px}
  .letters button{height:44px;font-weight:700}
  
  /* Mobile optimization for letter bank */
  @media (max-width: 480px) {
    .letters {
      grid-template-columns: repeat(auto-fit, minmax(36px, 1fr));
      gap: 6px;
      margin-top: 12px;
    }
    
    .letters button {
      height: 36px;
      font-size: 16px;
      font-weight: 600;
    }
  }
  .meta{display:flex;gap:10px;justify-content:center;color:#6b7280;font-size:14px}
  .feedback{min-height:28px;text-align:center;font-size:16px;margin-top:8px}
  .pill{display:inline-block;background:#eef2ff;color:#475569;padding:4px 10px;border-radius:999px;font-size:12px}
  .tiny{font-size:12px;color:#94a3b8}
  .bigword{font-size:34px;letter-spacing:3px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="game">
      <h1>Ellen's filling letter game</h1>
      <div class="controls">
        <!-- Audio playback button (hidden - moved to word display) -->
        <button id="speak" style="display:none">ðŸ”Š Play Audio</button>
        <!-- Show answer button (appears after wrong answer) -->
        <button id="showAnswer" class="hint" style="display:none">ðŸ’¡ Show Answer</button>
        <div class="status" id="status">Score 0 | Streak 0</div>
      </div>

      <div class="card">
        <div class="meta">
          <span class="pill" id="cat">â€”</span>
          <span class="tiny">Tip: Click letter cards below to fill blanks; click filled letters to remove.</span>
        </div>
        
        <!-- Game controls with speaker -->
        <div id="gameControls" class="word-display" style="display:none">
          <button id="wordSpeakBtn" class="word-speak-btn">ðŸ”Š Play</button>
          <button id="next" class="primary">New</button>
          <button id="replay">Retry</button>
        </div>
        
        <!-- Word puzzle and translation -->
        <div class="puzzle-container" style="display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0">
          <div id="mask" class="mask" style="margin:0"></div>
          <div id="wordTranslation" class="word-translation" style="display:none"></div>
        </div>
        <div id="letterBank" class="letters"></div>
        <div id="feedback" class="feedback"></div>
      </div>

      <div class="meta tiny">
        Source: Dolch Sight Words.
        <div id="voiceInfo" style="margin-top:8px;color:#6b7280;"></div>
      </div>
    </div>
  </div>

<script>
// ---- Dolch Words Database with Chinese Translations ----
const WORDS_WITH_TRANSLATIONS = {
  // PRE-K
  "a":"ä¸€ä¸ª", "and":"å’Œ", "away":"ç¦»å¼€", "big":"å¤§çš„", "blue":"è“è‰²", "can":"èƒ½å¤Ÿ", "come":"æ¥", "down":"ä¸‹", "find":"æ‰¾åˆ°", "for":"ä¸ºäº†", "funny":"æœ‰è¶£çš„", "go":"åŽ»", "help":"å¸®åŠ©", "here":"è¿™é‡Œ", "I":"æˆ‘", "in":"åœ¨...é‡Œ", "is":"æ˜¯", "it":"å®ƒ", "jump":"è·³", "little":"å°çš„", "look":"çœ‹", "make":"åˆ¶ä½œ", "me":"æˆ‘", "my":"æˆ‘çš„", "not":"ä¸", "one":"ä¸€", "play":"çŽ©", "red":"çº¢è‰²", "run":"è·‘", "said":"è¯´", "see":"çœ‹è§", "the":"è¿™ä¸ª", "three":"ä¸‰", "to":"åˆ°", "two":"äºŒ", "up":"ä¸Š", "we":"æˆ‘ä»¬", "where":"å“ªé‡Œ", "yellow":"é»„è‰²", "you":"ä½ ",
  // K
  "all":"å…¨éƒ¨", "am":"æ˜¯", "are":"æ˜¯", "at":"åœ¨", "ate":"åƒäº†", "be":"æ˜¯", "black":"é»‘è‰²", "brown":"æ£•è‰²", "but":"ä½†æ˜¯", "came":"æ¥äº†", "did":"åšäº†", "do":"åš", "eat":"åƒ", "four":"å››", "get":"å¾—åˆ°", "good":"å¥½çš„", "have":"æœ‰", "he":"ä»–", "into":"è¿›å…¥", "like":"å–œæ¬¢", "must":"å¿…é¡»", "new":"æ–°çš„", "no":"ä¸", "now":"çŽ°åœ¨", "on":"åœ¨...ä¸Š", "our":"æˆ‘ä»¬çš„", "out":"å¤–é¢", "please":"è¯·", "pretty":"æ¼‚äº®çš„", "ran":"è·‘äº†", "ride":"éª‘", "saw":"çœ‹è§äº†", "say":"è¯´", "she":"å¥¹", "so":"æ‰€ä»¥", "soon":"å¾ˆå¿«", "that":"é‚£ä¸ª", "there":"é‚£é‡Œ", "they":"ä»–ä»¬", "this":"è¿™ä¸ª", "too":"ä¹Ÿ", "under":"åœ¨...ä¸‹", "want":"æƒ³è¦", "was":"æ˜¯", "well":"å¥½", "went":"åŽ»äº†", "what":"ä»€ä¹ˆ", "white":"ç™½è‰²", "who":"è°", "will":"å°†è¦", "with":"å’Œ", "yes":"æ˜¯çš„",
  // G1
  "after":"ä¹‹åŽ", "again":"å†æ¬¡", "an":"ä¸€ä¸ª", "any":"ä»»ä½•", "as":"ä½œä¸º", "ask":"é—®", "by":"é€šè¿‡", "could":"èƒ½å¤Ÿ", "every":"æ¯ä¸ª", "fly":"é£ž", "from":"ä»Ž", "give":"ç»™", "going":"åŽ»", "had":"æœ‰äº†", "has":"æœ‰", "her":"å¥¹çš„", "him":"ä»–", "his":"ä»–çš„", "how":"æ€Žæ ·", "just":"åˆšåˆš", "know":"çŸ¥é“", "let":"è®©", "live":"ç”Ÿæ´»", "may":"å¯èƒ½", "of":"çš„", "old":"è€çš„", "once":"ä¸€æ¬¡", "open":"æ‰“å¼€", "over":"åœ¨...ä¸Šé¢", "put":"æ”¾", "round":"åœ†çš„", "some":"ä¸€äº›", "stop":"åœæ­¢", "take":"æ‹¿", "thank":"è°¢è°¢", "them":"ä»–ä»¬", "then":"ç„¶åŽ", "think":"æƒ³", "walk":"èµ°", "were":"æ˜¯", "when":"ä»€ä¹ˆæ—¶å€™",
  // G2
  "always":"æ€»æ˜¯", "around":"å‘¨å›´", "because":"å› ä¸º", "been":"æ˜¯", "before":"ä¹‹å‰", "best":"æœ€å¥½çš„", "both":"ä¸¤ä¸ªéƒ½", "buy":"ä¹°", "call":"å«", "cold":"å†·çš„", "does":"åš", "don't":"ä¸è¦", "fast":"å¿«çš„", "first":"ç¬¬ä¸€", "five":"äº”", "found":"æ‰¾åˆ°äº†", "gave":"ç»™äº†", "goes":"åŽ»", "green":"ç»¿è‰²", "its":"å®ƒçš„", "made":"åˆ¶ä½œäº†", "many":"è®¸å¤š", "off":"å…³", "or":"æˆ–è€…", "pull":"æ‹‰", "read":"è¯»", "right":"æ­£ç¡®çš„", "sing":"å”±æ­Œ", "sit":"å", "sleep":"ç¡è§‰", "tell":"å‘Šè¯‰", "their":"ä»–ä»¬çš„", "these":"è¿™äº›", "those":"é‚£äº›", "upon":"åœ¨...ä¹‹ä¸Š", "us":"æˆ‘ä»¬", "use":"ä½¿ç”¨", "very":"éžå¸¸", "wash":"æ´—", "which":"å“ªä¸ª", "why":"ä¸ºä»€ä¹ˆ", "wish":"å¸Œæœ›", "work":"å·¥ä½œ", "would":"ä¼š", "write":"å†™", "your":"ä½ çš„",
  // G3
  "about":"å…³äºŽ", "better":"æ›´å¥½çš„", "bring":"å¸¦æ¥", "carry":"æºå¸¦", "clean":"å¹²å‡€çš„", "cut":"åˆ‡", "done":"å®Œæˆ", "draw":"ç”»", "drink":"å–", "eight":"å…«", "fall":"ç§‹å¤©", "far":"è¿œçš„", "full":"æ»¡çš„", "got":"å¾—åˆ°äº†", "grow":"æˆé•¿", "hold":"æŠ“ä½", "hot":"çƒ­çš„", "hurt":"ä¼¤å®³", "if":"å¦‚æžœ", "keep":"ä¿æŒ", "kind":"å–„è‰¯çš„", "laugh":"ç¬‘", "light":"å…‰", "long":"é•¿çš„", "much":"å¾ˆå¤š", "myself":"æˆ‘è‡ªå·±", "never":"ä»Žä¸", "only":"åªæœ‰", "own":"è‡ªå·±çš„", "pick":"æŒ‘é€‰", "seven":"ä¸ƒ", "shall":"å°†è¦", "show":"æ˜¾ç¤º", "six":"å…­", "small":"å°çš„", "start":"å¼€å§‹", "ten":"å", "today":"ä»Šå¤©", "together":"ä¸€èµ·", "try":"å°è¯•", "warm":"æ¸©æš–çš„",
  // NOUNS
  "apple":"è‹¹æžœ", "baby":"å©´å„¿", "back":"èƒŒéƒ¨", "ball":"çƒ", "bear":"ç†Š", "bed":"åºŠ", "bell":"é“ƒ", "bird":"é¸Ÿ", "birthday":"ç”Ÿæ—¥", "boat":"èˆ¹", "box":"ç›’å­", "boy":"ç”·å­©", "bread":"é¢åŒ…", "brother":"å…„å¼Ÿ", "cake":"è›‹ç³•", "car":"æ±½è½¦", "cat":"çŒ«", "chair":"æ¤…å­", "chicken":"é¸¡", "children":"å­©å­ä»¬", "Christmas":"åœ£è¯žèŠ‚", "coat":"å¤–å¥—", "corn":"çŽ‰ç±³", "cow":"ç‰›", "day":"å¤©", "dog":"ç‹—", "doll":"å¨ƒå¨ƒ", "door":"é—¨", "duck":"é¸­å­", "egg":"è›‹", "eye":"çœ¼ç›", "farm":"å†œåœº", "farmer":"å†œæ°‘", "father":"çˆ¶äº²", "feet":"è„š", "fire":"ç«", "fish":"é±¼", "floor":"åœ°æ¿", "flower":"èŠ±", "game":"æ¸¸æˆ", "garden":"èŠ±å›­", "girl":"å¥³å­©", "goodbye":"å†è§", "grass":"è‰", "ground":"åœ°é¢", "hand":"æ‰‹", "head":"å¤´", "hill":"å±±ä¸˜", "home":"å®¶", "horse":"é©¬", "house":"æˆ¿å­", "kitty":"å°çŒ«", "leg":"è…¿", "letter":"å­—æ¯", "man":"ç”·äºº", "men":"ç”·äººä»¬", "milk":"ç‰›å¥¶", "money":"é’±", "morning":"æ—©æ™¨", "mother":"æ¯äº²", "name":"åå­—", "nest":"å·¢", "night":"å¤œæ™š", "paper":"çº¸", "party":"æ´¾å¯¹", "picture":"å›¾ç‰‡", "pig":"çŒª", "rabbit":"å…”å­", "rain":"é›¨", "ring":"æˆ’æŒ‡", "robin":"çŸ¥æ›´é¸Ÿ", "Santa Claus":"åœ£è¯žè€äºº", "school":"å­¦æ ¡", "seed":"ç§å­", "sheep":"ç¾Š", "shoe":"éž‹", "sister":"å§å¦¹", "snow":"é›ª", "song":"æ­Œ", "squirrel":"æ¾é¼ ", "stick":"æ£å­", "street":"è¡—é“", "sun":"å¤ªé˜³", "table":"æ¡Œå­", "thing":"ä¸œè¥¿", "time":"æ—¶é—´", "top":"é¡¶éƒ¨", "toy":"çŽ©å…·", "tree":"æ ‘", "watch":"æ‰‹è¡¨", "water":"æ°´", "way":"è·¯", "wind":"é£Ž", "window":"çª—æˆ·", "wood":"æœ¨å¤´"
};

const WORDS = [
  ...["a","and","away","big","blue","can","come","down","find","for","funny","go","help","here","I","in","is","it","jump","little","look","make","me","my","not","one","play","red","run","said","see","the","three","to","two","up","we","where","yellow","you"].map(w=>({w,g:"PRE-K",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["all","am","are","at","ate","be","black","brown","but","came","did","do","eat","four","get","good","have","he","into","like","must","new","no","now","on","our","out","please","pretty","ran","ride","saw","say","she","so","soon","that","there","they","this","too","under","want","was","well","went","what","white","who","will","with","yes"].map(w=>({w,g:"K",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["after","again","an","any","as","ask","by","could","every","fly","from","give","going","had","has","her","him","his","how","just","know","let","live","may","of","old","once","open","over","put","round","some","stop","take","thank","them","then","think","walk","were","when"].map(w=>({w,g:"G1",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["always","around","because","been","before","best","both","buy","call","cold","does","don't","fast","first","five","found","gave","goes","green","its","made","many","off","or","pull","read","right","sing","sit","sleep","tell","their","these","those","upon","us","use","very","wash","which","why","wish","work","would","write","your"].map(w=>({w,g:"G2",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["about","better","bring","carry","clean","cut","done","draw","drink","eight","fall","far","full","got","grow","hold","hot","hurt","if","keep","kind","laugh","light","long","much","myself","never","only","own","pick","seven","shall","show","six","small","start","ten","today","together","try","warm"].map(w=>({w,g:"G3",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["apple","baby","back","ball","bear","bed","bell","bird","birthday","boat","box","boy","bread","brother","cake","car","cat","chair","chicken","children","Christmas","coat","corn","cow","day","dog","doll","door","duck","egg","eye","farm","farmer","father","feet","fire","fish","floor","flower","game","garden","girl","goodbye","grass","ground","hand","head","hill","home","horse","house","kitty","leg","letter","man","men","milk","money","morning","mother","name","nest","night","paper","party","picture","pig","rabbit","rain","ring","robin","Santa Claus","school","seed","sheep","shoe","sister","snow","song","squirrel","stick","street","sun","table","thing","time","top","toy","tree","watch","water","way","wind","window","wood"].map(w=>({w,g:"NOUNS",t:WORDS_WITH_TRANSLATIONS[w]})),
];

// ---- Game State ----
let current = null;
let score = 0, streak = 0;
let autoNextTimer = null; // Auto next question timer

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const elMask = $("#mask");
const elBank = $("#letterBank");
const elFeedback = $("#feedback");
const elStatus = $("#status");
const elCat = $("#cat");

// Safe DOM event binding with error handling
function bindEvents() {
  try {
    $("#next")?.addEventListener("click", newRound);
    $("#replay")?.addEventListener("click", () => {
      // Clear auto next timer
      if(autoNextTimer) {
        clearInterval(autoNextTimer);
        autoNextTimer = null;
      }
      current && setupRound(current.word, current.missingIdxs, current.translation);
    });
    $("#speak")?.addEventListener("click", ()=> current && speakWord(current.word));
    $("#showAnswer")?.addEventListener("click", showAnswer);
    
    // Bind word speak button when it becomes available
    setTimeout(() => {
      $("#wordSpeakBtn")?.addEventListener("click", ()=> current && speakWord(current.word));
    }, 100);
  } catch (error) {
    console.error("Error binding events:", error);
  }
}

// Call event binding
bindEvents();

// ---------- British TTS: Web Speech API ----------
let VOICES = [];
let UK_VOICE = null;

function loadVoices() {
  VOICES = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  // Priority: High-quality English voices for clearer pronunciation
  UK_VOICE =
    // 1. Native English voices (premium quality)
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-gb" && v.localService) ||
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-us" && v.localService) ||
    // 2. Any English GB voices
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-gb") ||
    // 3. Clear US voices as fallback
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-us") ||
    // 4. Names containing quality indicators
    VOICES.find(v => /uk|british|english|samantha|alex|daniel|karen|moira/i.test(v.name)) ||
    // 5. Any English voice
    VOICES.find(v => /^en[-_]/i.test(v.lang)) || null;
  
  console.log('Selected voice:', UK_VOICE?.name, UK_VOICE?.lang, UK_VOICE?.localService ? '(Local)' : '(Network)');
  
  // Update speech button text based on available voice quality
  const speakBtn = $("#speak");
  if (UK_VOICE?.localService) {
    speakBtn.textContent = "ðŸ”Š Play Audio (HD)";
    speakBtn.title = "High-quality local voice: " + UK_VOICE.name;
  } else if (UK_VOICE) {
    speakBtn.textContent = "ðŸ”Š Play Audio";
    speakBtn.title = "Using voice: " + UK_VOICE.name;
  } else {
    speakBtn.textContent = "ðŸ”Š Play Audio (Basic)";
    speakBtn.title = "Using default system voice";
  }
  
  // Update voice info display
  const voiceInfo = $("#voiceInfo");
  if (voiceInfo) {
    if (UK_VOICE?.localService) {
      voiceInfo.textContent = `Using high-quality voice: ${UK_VOICE.name}`;
    } else if (UK_VOICE) {
      voiceInfo.textContent = `Using voice: ${UK_VOICE.name}`;
    } else {
      voiceInfo.textContent = "Using default voice. For better pronunciation, use Chrome or Safari with system voices enabled.";
    }
  }
}

// Some browsers (Chrome) need voiceschanged listener for complete voice list
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
} else {
  // Disable button if not supported
  $("#speak").disabled = true;
  $("#speak").title = "Current browser doesn't support speech synthesis";
}

function speakWord(text){
  if(!('speechSynthesis' in window)) return;
  // Stop any ongoing speech
  speechSynthesis.cancel();
  
  // Add a small delay to ensure speech engine is ready
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance();
    
    // Set voice for clearer pronunciation
    if (UK_VOICE) {
      u.voice = UK_VOICE;
      u.lang = UK_VOICE.lang;
    } else {
      u.lang = "en-US";  // Fallback to US English for better compatibility
    }
    
    // Normal mode settings
    u.rate = 0.8;     // Slightly slower than default
    u.pitch = 1.1;    // Slightly higher pitch for clarity
    u.volume = 1.0;
    u.text = text;
    
    speechSynthesis.speak(u);
  }, 100);  // 100ms delay before starting
}

// Show answer functionality
function showAnswer(){
  if(!current) return;
  const word = current.word;
  const missingIdxs = current.missingIdxs;
  
  // Fill correct answers into blank slots
  const holes = [...$$(".slot.hole")];
  const chars = [...word];
  holes.forEach((hole, index) => {
    const charIndex = parseInt(hole.dataset.idx);
    if(missingIdxs.has(charIndex)){
      hole.textContent = chars[charIndex].toLowerCase();
      hole.dataset.filled = "1";
      hole.dataset.letter = chars[charIndex].toLowerCase();
      // Add visual indicator for shown answer
      hole.style.backgroundColor = "#fff3cd";
      hole.style.border = "2px solid #ffc107";
    }
  });
  
  // Clear letter bank
  elBank.innerHTML = "";
  
  // Show feedback
  elFeedback.innerHTML = "ðŸ’¡ Answer is: <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")";
  
  // Hide show answer button
  $("#showAnswer").style.display = "none";
}

// ---- Game Logic ----
function newRound(){
  try {
    // Clear any ongoing auto next timer
    if(autoNextTimer) {
      clearInterval(autoNextTimer);
      autoNextTimer = null;
    }
    // Hide show answer button
    const showAnswerBtn = $("#showAnswer");
    if(showAnswerBtn) showAnswerBtn.style.display = "none";
    
    // Use all words without grade filtering
    const pool = WORDS;
    
    if(!pool.length){ 
      alert("No words available"); 
      return; 
    }
    
    const item = pool[Math.floor(Math.random()*pool.length)];
    if(!item || !item.w) {
      console.error("Invalid word item:", item);
      return;
    }
    
    const word = item.w.replace(/\s+/g,"");
    if(!word || word.length < 1) {
      console.error("Invalid word:", word);
      return;
    }
    
    // Standard difficulty: 2 letters for longer words, 1 letter for 2-letter words
    let holes;
    if (word.length <= 2) {
      holes = 1;  // Only remove 1 letter for very short words
    } else {
      holes = Math.min(2, word.length - 1);  // Remove 2 letters, but leave at least 1
    }
    const missingIdxs = makeMissingIndexes(word.length, holes);
    
    current = {word, missingIdxs, translation:item.t};
    setupRound(word, missingIdxs, item.t);
  } catch (error) {
    console.error("Error in newRound:", error);
    const feedback = $("#feedback");
    if(feedback) feedback.textContent = "Game error occurred. Please refresh the page.";
  }
}

// Dynamic slot sizing for mobile devices
function adjustSlotSizeForMobile(wordLength) {
  if (window.innerWidth <= 480) {
    const availableWidth = window.innerWidth - 60; // Account for padding and margins (reduced from 80 to 60)
    const gapWidth = 8 * (wordLength - 1); // 8px gap between slots
    const slotWidth = Math.floor((availableWidth - gapWidth) / wordLength);
    
    // Ensure minimum and maximum slot sizes
    const finalSlotWidth = Math.max(28, Math.min(44, slotWidth));
    const fontSize = Math.max(16, Math.min(28, finalSlotWidth * 0.6));
    const gapSize = Math.max(4, Math.min(8, finalSlotWidth * 0.15));
    
    // Calculate total word width to determine if centering is possible
    const totalWordWidth = (finalSlotWidth * wordLength) + (gapSize * (wordLength - 1));
    const needsScroll = totalWordWidth > availableWidth;
    
    // Apply custom styles
    const style = document.createElement('style');
    style.id = 'dynamic-slot-style';
    
    // Remove existing dynamic style if it exists
    const existingStyle = document.getElementById('dynamic-slot-style');
    if (existingStyle) {
      existingStyle.remove();
    }
    
    style.textContent = `
      @media (max-width: 480px) {
        .slot {
          width: ${finalSlotWidth}px !important;
          height: ${Math.max(36, finalSlotWidth * 1.2)}px !important;
          font-size: ${fontSize}px !important;
        }
        .mask {
          gap: ${gapSize}px !important;
          justify-content: ${needsScroll ? 'flex-start' : 'center'} !important;
          ${needsScroll ? 'padding-left: 10px !important;' : ''}
        }
        .puzzle-container {
          align-items: center !important;
        }
      }
    `;
    
    document.head.appendChild(style);
  }
}

function setupRound(word, missingIdxs, translation){
  elMask.innerHTML = "";
  elBank.innerHTML = "";
  elFeedback.textContent = "";
  elCat.textContent = "Dolch Sight Words";
  // Hide show answer button
  $("#showAnswer").style.display = "none";
  // Clear any previous answer display styles
  [...$$(".slot")].forEach(slot => {
    slot.style.backgroundColor = "";
    slot.style.border = "";
  });
  
  // Show game controls and translation
  const gameControls = $("#gameControls");
  const wordTranslation = $("#wordTranslation");
  
  gameControls.style.display = "flex";
  wordTranslation.style.display = "block";
  wordTranslation.textContent = translation || current.translation || "";
  
  // Dynamic slot sizing for mobile
  adjustSlotSizeForMobile(word.length);
  
  const chars = [...word];
  const missingLetters = [];

  chars.forEach((ch, i)=>{
    const div = document.createElement("div");
    div.className = "slot" + (missingIdxs.has(i) ? " hole" : "");
    if(missingIdxs.has(i)){
      div.dataset.idx = i;
      div.textContent = "â€”";
      div.addEventListener("click", ()=>{
        if(div.dataset.filled){
          addLetterToBank(div.dataset.letter);
          div.textContent = "â€”";
          div.dataset.filled = "";
          div.dataset.letter = "";
        }
      });
      missingLetters.push(ch);
    } else {
      div.textContent = ch;
    }
    elMask.appendChild(div);
  });

  const distractors = makeDistractors(missingLetters, word);
  const bank = shuffle([...missingLetters, ...distractors]);
  bank.forEach(letter => addLetterToBank(letter));

  function addLetterToBank(letter){
    const btn = document.createElement("button");
    btn.textContent = letter.toLowerCase();
    btn.addEventListener("click", ()=>{
      const hole = [...$$(".slot.hole")].find(s=>!s.dataset.filled);
      if(!hole) return;
      hole.textContent = letter.toLowerCase();
      hole.dataset.filled = "1";
      hole.dataset.letter = letter;
      btn.remove();
      checkProgress();
    });
    elBank.appendChild(btn);
  }

  function checkProgress(){
    const filled = [...$$(".slot.hole")].every(s=>s.dataset.filled==="1");
    if(!filled) return;
    const guess = [...$$(".slot")].map(s=> (s.classList.contains("hole") ? (s.dataset.letter||"") : s.textContent)).join("").toLowerCase();
    const ok = guess === word.toLowerCase();
    if(ok){
      streak++; score += 10 + Math.max(0, (streak-1)*2);
      elFeedback.innerHTML = "âœ… Great! The word is <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")";
      $("#next").classList.add("good");
      setTimeout(()=>{$("#next").classList.remove("good")},600);
      // Hide show answer button when correct
      $("#showAnswer").style.display = "none";
      
      // Show countdown and auto next question
      let countdown = 3;
      autoNextTimer = setInterval(()=>{
        countdown--;
        if(countdown > 0){
          elFeedback.innerHTML = "âœ… Great! The word is <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")<br/>ðŸ“ " + countdown + " seconds until next question...";
        } else {
          clearInterval(autoNextTimer);
          autoNextTimer = null;
          newRound();
        }
      }, 1000);
    }else{
      streak=0; score = Math.max(0, score-2);
      elFeedback.innerHTML = "âŒ Try again! Click slots to remove letters.";
      $("#replay").classList.add("bad");
      setTimeout(()=>{$("#replay").classList.remove("bad")},600);
      // Show answer button after wrong answer
      $("#showAnswer").style.display = "inline-block";
    }
    elStatus.textContent = `Score ${score} | Streak ${streak}`;
  }
}

function makeMissingIndexes(len, n){
  const idxs = new Set();
  
  // Calculate available positions (exclude first and last for words > 2 letters)
  let availablePositions = [];
  if(len <= 2) {
    // For very short words, allow any position except keeping at least 1
    availablePositions = [...Array(len).keys()];
  } else {
    // For longer words, exclude first and last positions
    availablePositions = [...Array(len).keys()].slice(1, -1);
  }
  
  // Limit n to available positions to prevent infinite loop
  const maxPossible = Math.min(n, availablePositions.length, len - 1);
  
  // Shuffle available positions for random selection
  const shuffledPositions = shuffle([...availablePositions]);
  
  // Select the required number of positions
  for(let i = 0; i < maxPossible; i++) {
    idxs.add(shuffledPositions[i]);
  }
  
  return idxs;
}

function makeDistractors(missingLetters, word){
  const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
  const need = Math.max(3, missingLetters.length);
  const pool = new Set();
  
  // Add neighboring letters for confusion
  word.split("").forEach(ch=>{
    const i = alphabet.indexOf(ch.toLowerCase());
    if(i>0) pool.add(alphabet[i-1]);
    if(i<alphabet.length-1) pool.add(alphabet[i+1]);
  });
  
  // Add random letters with safety limit to prevent infinite loop
  let attempts = 0;
  const maxAttempts = 100; // Safety limit
  while(pool.size < Math.min(need*2, 20) && attempts < maxAttempts){
    pool.add(alphabet[Math.floor(Math.random()*alphabet.length)]);
    attempts++;
  }
  
  // Remove letters that are already in the missing letters
  missingLetters.forEach(ch=> pool.delete(ch.toLowerCase()));
  
  // Return the needed number of distractors
  return shuffle([...pool]).slice(0, need);
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

// Handle window resize for mobile optimization
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (current && current.word) {
      adjustSlotSizeForMobile(current.word.length);
    }
  }, 250);
});

// Start first question with error handling
setTimeout(() => {
  try {
    // Ensure DOM is ready and all elements are available
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => newRound());
    } else {
      newRound();
    }
  } catch (error) {
    console.error("Error starting game:", error);
    const feedback = $("#feedback");
    if(feedback) feedback.textContent = "Failed to start game. Please refresh the page.";
  }
}, 100);
</script>
</body>
</html>
