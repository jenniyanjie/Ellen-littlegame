<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ellen's Missing Letter</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#1f2d3d; --muted:#708090;
    --accent:#5c7cfa; --ok:#22c55e; --bad:#ef4444;
  }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,Arial;}
  body{background:linear-gradient(180deg,#eef2ff, #f6f7fb);}
  .wrap{max-width:1440px;margin:28px auto;padding:28px;}
  .game{background:var(--card);box-shadow:0 12px 36px rgba(21,24,79,.08);border-radius:19px;padding:24px;}
  h1{margin:10px 0 14px;font-size:38px;color:var(--ink)}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  select,button{border:1px solid #dce0f0;border-radius:12px;padding:14px 19px;background:#fff;color:var(--ink);font-size:19px;cursor:pointer}
  button.primary{background:var(--accent);color:#fff;border:none}
  button.good{background:var(--ok);color:#fff;border:none}
  button.bad{background:var(--bad);color:#fff;border:none}
  button.hint{background:#ffc107;color:#212529;border:none;font-weight:600}
  .status{margin-left:auto;color:var(--muted);font-size:13px}
  .card{margin:18px 0;padding:18px;border:1px dashed #e3e7ff;border-radius:12px;background:#fafbff}
  .word-display{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08);border:2px solid #eef2ff}
  .word-speak-btn{padding:14px 24px;border:none;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer;font-size:22px;display:flex;align-items:center;gap:10px;transition:all 0.2s}
  .word-speak-btn:hover{background:#4c68d9;transform:scale(1.05)}
  .word-speak-btn:active{transform:scale(0.98)}
  .word-translation{color:var(--muted);font-size:24px;font-weight:500;background:#f8faff;padding:14px 19px;border-radius:7px;border:1px solid #e3e7ff}
  .mask{display:flex;gap:10px;flex-wrap:nowrap;justify-content:center;margin:14px 0;overflow-x:auto;padding:5px}
  .slot{width:77px;height:96px;border-radius:14px;background:#fff;display:grid;place-items:center;
        box-shadow:0 7px 17px rgba(0,0,0,.06);font-size:43px;font-weight:700;letter-spacing:1px;flex-shrink:0}
  .slot.hole{outline:2px dashed #c7d2fe; background:#f8faff;color:#9aa3b2}
  
  /* Mobile responsive design */
  @media (max-width: 768px) {
    .puzzle-container {
      flex-direction: column !important;
      gap: 12px !important;
      margin: 12px 0 !important;
      align-items: center !important;
    }
    
    .mask {
      width: 100%;
      max-width: calc(100vw - 40px);
      justify-content: center;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding: 0 10px;
    }
    
    .mask::-webkit-scrollbar {
      display: none;
    }
    
    /* Ensure translation is centered when displayed */
    .word-translation {
      text-align: center;
      align-self: center;
    }
  }
  
  @media (max-width: 480px) {
    .slot {
      width: calc((100vw - 80px) / 8);
      min-width: 48px;
      max-width: 67px;
      height: 72px;
      font-size: 34px;
    }
    
    .word-translation {
      font-size: 22px;
      padding: 10px 14px;
    }
    
    .word-display {
      gap: 14px;
      margin: 14px 0;
      padding: 14px;
    }
    
    .word-speak-btn {
      padding: 12px 19px;
      font-size: 19px;
    }
  }
  .letters{display:grid;grid-template-columns:repeat(auto-fit,minmax(67px,1fr));gap:14px;margin-top:14px}
  .letters button{height:67px;font-weight:700;font-size:29px}
  .letters button.used{background:#e5e7eb;color:#9ca3af;cursor:not-allowed;opacity:0.6}
  .letters button.used:hover{background:#e5e7eb;transform:none}
  
  /* Mobile optimization for letter bank */
  @media (max-width: 480px) {
    .letters {
      grid-template-columns: repeat(auto-fit, minmax(58px, 1fr));
      gap: 10px;
      margin-top: 14px;
    }
    
    .letters button {
      height: 58px;
      font-size: 26px;
      font-weight: 600;
    }
  }
  .meta{display:flex;gap:14px;justify-content:center;color:#6b7280;font-size:19px}
  .feedback{min-height:38px;text-align:center;font-size:24px;margin-top:14px}
  .pill{display:inline-block;background:#eef2ff;color:#475569;padding:7px 17px;border-radius:999px;font-size:17px}
  .tiny{font-size:17px;color:#94a3b8}
  .bigword{font-size:50px;letter-spacing:5px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="game">
      <h1>Ellen's filling letter game</h1>
      <div class="controls">
        <!-- Audio playback button (hidden - moved to word display) -->
        <button id="speak" style="display:none">🔊 Play Audio</button>
        <!-- Show answer button (appears after wrong answer) -->
        <button id="showAnswer" class="hint" style="display:none">💡 Show Answer</button>
        <div class="status" id="status">Score 0 | Streak 0 | Progress: 0/0</div>
      </div>

      <div class="card">
        <div class="meta">
          <span class="pill" id="cat">—</span>
          <span class="tiny">Tip: Click letter cards below to fill blanks; click filled letters to remove.</span>
        </div>
        
        <!-- Game controls with speaker -->
        <div id="gameControls" class="word-display">
          <button id="wordSpeakBtn" class="word-speak-btn">🔊 Play</button>
          <button id="next" class="primary">New</button>
          <button id="replay">Retry</button>
        </div>
        
        <!-- Word puzzle and translation -->
        <div class="puzzle-container" style="display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0">
          <div id="mask" class="mask" style="margin:0"></div>
          <div id="wordTranslation" class="word-translation" style="display:none"></div>
        </div>
        <div id="letterBank" class="letters"></div>
        <div id="feedback" class="feedback"></div>
      </div>

      <div class="meta tiny" style="display:none;">
        Source: Dolch Sight Words.
        <div id="voiceInfo" style="display:none;"></div>
      </div>
    </div>
  </div>

<script>
// ---- Dolch Words Database with Chinese Translations ----
const WORDS_WITH_TRANSLATIONS = {
  // New words from user's curriculum
  "were":"是", "yes":"是的", "may":"可能", "or":"或者", "an":"一个", "tail":"尾巴", "paws":"爪子", "fur":"毛皮", "beak":"鸟嘴", "feathers":"羽毛",
  "around":"周围", "animals":"动物", "eyes":"眼睛", "wish":"希望", "then":"然后", "growl":"咆哮", "prowl":"潜行", "mouth":"嘴巴", "fright":"恐惧", "scream":"尖叫",
  "must":"必须", "much":"很多", "will":"将要", "a":"一个", "than":"比", "many":"许多", "cruel":"残忍的", "dream":"梦想", "leaf":"树叶", "breeze":"微风",
  "gives":"给", "they":"他们", "dog":"狗", "great":"伟大的", "back":"背部", "pears":"梨", "toast":"吐司", "sweet":"甜的", "throws":"扔", "catch":"抓住",
  "sea":"海", "head":"头", "now":"现在", "across":"穿过", "called":"被叫", "scared":"害怕的", "asleep":"睡着的", "angry":"生气的", "flew":"飞了", "world":"世界",
  "something":"某事", "look":"看", "coming":"来", "because":"因为", "whole":"整个", "some":"一些", "love":"爱", "feel":"感觉", "show":"展示", "short":"短的",
  "cold":"冷的", "sleeping":"睡觉", "lived":"生活", "if":"如果", "go":"去", "hear":"听", "near":"附近", "bottom":"底部", "behind":"后面", "sneak":"偷偷",
  "other":"其他", "cannot":"不能", "never":"从不", "as":"作为", "two":"二", "together":"一起", "again":"再次", "corner":"角落", "teach":"教", "watch":"观看",
  "going":"去", "thought":"想法", "soon":"很快", "got":"得到", "keep":"保持", "change":"改变", "space":"空间", "stars":"星星", "rocket":"火箭", "sky":"天空",
  "Mr":"先生", "morning":"早晨", "right":"正确的", "know":"知道", "still":"仍然", "happen":"发生", "pretty":"漂亮的", "beside":"在旁边", "inside":"里面", "outside":"外面",
  // G1
  "after":"之后", "again":"再次", "an":"一个", "any":"任何", "as":"作为", "ask":"问", "by":"通过", "could":"能够", "every":"每个", "fly":"飞", "from":"从", "give":"给", "going":"去", "had":"有了", "has":"有", "her":"她的", "him":"他", "his":"他的", "how":"怎样", "just":"刚刚", "know":"知道", "let":"让", "live":"生活", "may":"可能", "of":"的", "old":"老的", "once":"一次", "open":"打开", "over":"在...上面", "put":"放", "round":"圆的", "some":"一些", "stop":"停止", "take":"拿", "thank":"谢谢", "them":"他们", "then":"然后", "think":"想", "walk":"走", "were":"是", "when":"什么时候",
  // G2
  "always":"总是", "around":"周围", "because":"因为", "been":"是", "before":"之前", "best":"最好的", "both":"两个都", "buy":"买", "call":"叫", "cold":"冷的", "does":"做", "don't":"不要", "fast":"快的", "first":"第一", "five":"五", "found":"找到了", "gave":"给了", "goes":"去", "green":"绿色", "its":"它的", "made":"制作了", "many":"许多", "off":"关", "or":"或者", "pull":"拉", "read":"读", "right":"正确的", "sing":"唱歌", "sit":"坐", "sleep":"睡觉", "tell":"告诉", "their":"他们的", "these":"这些", "those":"那些", "upon":"在...之上", "us":"我们", "use":"使用", "very":"非常", "wash":"洗", "which":"哪个", "why":"为什么", "wish":"希望", "work":"工作", "would":"会", "write":"写", "your":"你的",
  // G3
  "about":"关于", "better":"更好的", "bring":"带来", "carry":"携带", "clean":"干净的", "cut":"切", "done":"完成", "draw":"画", "drink":"喝", "eight":"八", "fall":"秋天", "far":"远的", "full":"满的", "got":"得到了", "grow":"成长", "hold":"抓住", "hot":"热的", "hurt":"伤害", "if":"如果", "keep":"保持", "kind":"善良的", "laugh":"笑", "light":"光", "long":"长的", "much":"很多", "myself":"我自己", "never":"从不", "only":"只有", "own":"自己的", "pick":"挑选", "seven":"七", "shall":"将要", "show":"显示", "six":"六", "small":"小的", "start":"开始", "ten":"十", "today":"今天", "together":"一起", "try":"尝试", "warm":"温暖的",
  // NOUNS
  "apple":"苹果", "baby":"婴儿", "back":"背部", "ball":"球", "bear":"熊", "bed":"床", "bell":"铃", "bird":"鸟", "birthday":"生日", "boat":"船", "box":"盒子", "boy":"男孩", "bread":"面包", "brother":"兄弟", "cake":"蛋糕", "car":"汽车", "cat":"猫", "chair":"椅子", "chicken":"鸡", "children":"孩子们", "Christmas":"圣诞节", "coat":"外套", "corn":"玉米", "cow":"牛", "day":"天", "dog":"狗", "doll":"娃娃", "door":"门", "duck":"鸭子", "egg":"蛋", "eye":"眼睛", "farm":"农场", "farmer":"农民", "father":"父亲", "feet":"脚", "fire":"火", "fish":"鱼", "floor":"地板", "flower":"花", "game":"游戏", "garden":"花园", "girl":"女孩", "goodbye":"再见", "grass":"草", "ground":"地面", "hand":"手", "head":"头", "hill":"山丘", "home":"家", "horse":"马", "house":"房子", "kitty":"小猫", "leg":"腿", "letter":"字母", "man":"男人", "men":"男人们", "milk":"牛奶", "money":"钱", "morning":"早晨", "mother":"母亲", "name":"名字", "nest":"巢", "night":"夜晚", "paper":"纸", "party":"派对", "picture":"图片", "pig":"猪", "rabbit":"兔子", "rain":"雨", "ring":"戒指", "robin":"知更鸟", "Santa Claus":"圣诞老人", "school":"学校", "seed":"种子", "sheep":"羊", "shoe":"鞋", "sister":"姐妹", "snow":"雪", "song":"歌", "squirrel":"松鼠", "stick":"棍子", "street":"街道", "sun":"太阳", "table":"桌子", "thing":"东西", "time":"时间", "top":"顶部", "toy":"玩具", "tree":"树", "watch":"手表", "water":"水", "way":"路", "wind":"风", "window":"窗户", "wood":"木头"
};

const WORDS = [
  // New curriculum words - avoiding duplicates with existing G1-G3 and NOUNS
  ...["were","yes","may","or","an","tail","paws","fur","beak","feathers","around","animals","eyes","wish","then","growl","prowl","mouth","fright","scream","must","much","will","a","than","many","cruel","dream","leaf","breeze","gives","they","dog","great","back","pears","toast","sweet","throws","catch","sea","head","now","across","called","scared","asleep","angry","flew","world","something","look","coming","because","whole","some","love","feel","show","short","cold","sleeping","lived","if","go","hear","near","bottom","behind","sneak","other","cannot","never","as","two","together","again","corner","teach","watch","going","thought","soon","got","keep","change","space","stars","rocket","sky","Mr","morning","right","know","still","happen","pretty","beside","inside","outside"].filter(w => WORDS_WITH_TRANSLATIONS[w]).map(w=>({w,g:"NEW",t:WORDS_WITH_TRANSLATIONS[w]})),
  // Keep existing G1-G3 words that are not duplicated in new words
  ...["after","any","ask","by","could","every","fly","from","give","had","has","her","him","his","how","just","let","live","of","old","once","open","over","put","round","stop","take","thank","them","think","walk","when"].map(w=>({w,g:"G1",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["always","been","before","best","both","buy","call","does","don't","fast","first","five","found","gave","goes","green","its","made","off","pull","read","sing","sit","sleep","tell","their","these","those","upon","us","use","very","wash","which","why","work","would","write","your"].map(w=>({w,g:"G2",t:WORDS_WITH_TRANSLATIONS[w]})),
  ...["about","better","bring","carry","clean","cut","done","draw","drink","eight","fall","far","full","grow","hold","hot","hurt","kind","laugh","light","long","myself","only","own","pick","seven","shall","six","small","start","ten","today","try","warm"].map(w=>({w,g:"G3",t:WORDS_WITH_TRANSLATIONS[w]})),
  // Keep existing NOUNS that are not duplicated in new words 
  ...["apple","baby","ball","bear","bed","bell","bird","birthday","boat","box","boy","bread","brother","cake","car","cat","chair","chicken","children","Christmas","coat","corn","cow","day","doll","door","duck","egg","eye","farm","farmer","father","feet","fire","fish","floor","flower","game","garden","girl","goodbye","grass","ground","hand","hill","home","horse","house","kitty","leg","letter","man","men","milk","money","mother","name","nest","night","paper","party","picture","pig","rabbit","rain","ring","robin","Santa Claus","school","seed","sheep","shoe","sister","snow","song","squirrel","stick","street","sun","table","thing","time","top","toy","tree","water","way","wind","window","wood"].map(w=>({w,g:"NOUNS",t:WORDS_WITH_TRANSLATIONS[w]})),
];

// ---- Game State ----
let current = null;
let score = 0, streak = 0;
let autoNextTimer = null; // Auto next question timer
let usedWords = new Set(); // Track used words to avoid repetition

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const elMask = $("#mask");
const elBank = $("#letterBank");
const elFeedback = $("#feedback");
const elStatus = $("#status");
const elCat = $("#cat");

// Safe DOM event binding with error handling
function bindEvents() {
  try {
    $("#next")?.addEventListener("click", newRound);
    $("#replay")?.addEventListener("click", () => {
      // Clear auto next timer
      if(autoNextTimer) {
        clearInterval(autoNextTimer);
        autoNextTimer = null;
      }
      current && setupRound(current.word, current.missingIdxs, current.translation);
    });
    $("#speak")?.addEventListener("click", ()=> current && speakWord(current.word));
    $("#showAnswer")?.addEventListener("click", showAnswer);
    
    // Bind word speak button when it becomes available
    setTimeout(() => {
      $("#wordSpeakBtn")?.addEventListener("click", ()=> current && speakWord(current.word));
    }, 100);
  } catch (error) {
    console.error("Error binding events:", error);
  }
}

// Call event binding
bindEvents();

// ---------- British TTS: Web Speech API ----------
let VOICES = [];
let UK_VOICE = null;

function loadVoices() {
  VOICES = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  // Priority: High-quality English voices for clearer pronunciation
  UK_VOICE =
    // 1. Native English voices (premium quality)
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-gb" && v.localService) ||
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-us" && v.localService) ||
    // 2. Any English GB voices
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-gb") ||
    // 3. Clear US voices as fallback
    VOICES.find(v => v.lang && v.lang.toLowerCase() === "en-us") ||
    // 4. Names containing quality indicators
    VOICES.find(v => /uk|british|english|samantha|alex|daniel|karen|moira/i.test(v.name)) ||
    // 5. Any English voice
    VOICES.find(v => /^en[-_]/i.test(v.lang)) || null;
  
  console.log('Selected voice:', UK_VOICE?.name, UK_VOICE?.lang, UK_VOICE?.localService ? '(Local)' : '(Network)');
  
  // Update speech button text based on available voice quality
  // Simplified button text without voice quality info
  const speakBtn = $("#speak");
  speakBtn.textContent = "🔊 Play Audio";
  speakBtn.title = "Play pronunciation";
  
  // Voice info display is hidden
}

// Some browsers (Chrome) need voiceschanged listener for complete voice list
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
} else {
  // Disable button if not supported
  $("#speak").disabled = true;
  $("#speak").title = "Current browser doesn't support speech synthesis";
}

function speakWord(text){
  if(!('speechSynthesis' in window)) return;
  // Stop any ongoing speech
  speechSynthesis.cancel();
  
  // Add a small delay to ensure speech engine is ready
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance();
    
    // Set voice for clearer pronunciation
    if (UK_VOICE) {
      u.voice = UK_VOICE;
      u.lang = UK_VOICE.lang;
    } else {
      u.lang = "en-US";  // Fallback to US English for better compatibility
    }
    
    // Normal mode settings
    u.rate = 0.8;     // Slightly slower than default
    u.pitch = 1.1;    // Slightly higher pitch for clarity
    u.volume = 1.0;
    u.text = text;
    
    speechSynthesis.speak(u);
  }, 100);  // 100ms delay before starting
}

// Show answer functionality
function showAnswer(){
  if(!current) return;
  const word = current.word;
  const missingIdxs = current.missingIdxs;
  
  // Fill correct answers into blank slots
  const holes = [...$$(".slot.hole")];
  const chars = [...word];
  holes.forEach((hole, index) => {
    const charIndex = parseInt(hole.dataset.idx);
    if(missingIdxs.has(charIndex)){
      hole.textContent = chars[charIndex].toLowerCase();
      hole.dataset.filled = "1";
      hole.dataset.letter = chars[charIndex].toLowerCase();
      // Add visual indicator for shown answer
      hole.style.backgroundColor = "#fff3cd";
      hole.style.border = "2px solid #ffc107";
    }
  });
  
  // Reset all letter buttons to unused state
  [...$$(".letters button")].forEach(btn => {
    btn.classList.remove("used");
  });
  
  // Show feedback
  elFeedback.innerHTML = "💡 Answer is: <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")";
  
  // Hide show answer button
  $("#showAnswer").style.display = "none";
}

// ---- Game Logic ----
function newRound(){
  try {
    // Clear any ongoing auto next timer
    if(autoNextTimer) {
      clearInterval(autoNextTimer);
      autoNextTimer = null;
    }
    // Hide show answer button
    const showAnswerBtn = $("#showAnswer");
    if(showAnswerBtn) showAnswerBtn.style.display = "none";
    
    // Filter out used words from the pool
    let availableWords = WORDS.filter(item => !usedWords.has(item.w));
    
    // If all words have been used, reset the used words set and start over
    if(availableWords.length === 0) {
      usedWords.clear();
      availableWords = WORDS.slice(); // Create a copy of all words
      console.log("All words completed! Starting new cycle.");
      // Show feedback to user about completing all words
      const feedback = $("#feedback");
      if(feedback) {
        feedback.innerHTML = "🎉 Congratulations! You've completed all " + WORDS.length + " words! Starting a new cycle...";
        setTimeout(() => {
          if(feedback) feedback.textContent = "";
        }, 3000);
      }
    }
    
    if(!availableWords.length){ 
      alert("No words available"); 
      return; 
    }
    
    const item = availableWords[Math.floor(Math.random()*availableWords.length)];
    if(!item || !item.w) {
      console.error("Invalid word item:", item);
      return;
    }
    
    // Add the selected word to used words set
    usedWords.add(item.w);
    
    const word = item.w.replace(/\s+/g,"");
    if(!word || word.length < 1) {
      console.error("Invalid word:", word);
      return;
    }
    
    // Standard difficulty: 2 letters for longer words, 1 letter for 2-letter words
    let holes;
    if (word.length <= 2) {
      holes = 1;  // Only remove 1 letter for very short words
    } else {
      holes = Math.min(2, word.length - 1);  // Remove 2 letters, but leave at least 1
    }
    const missingIdxs = makeMissingIndexes(word.length, holes);
    
    current = {word, missingIdxs, translation:item.t};
    setupRound(word, missingIdxs, item.t);
    
    // Update status with progress information
    const totalWords = WORDS.length;
    const completedWords = usedWords.size;
    elStatus.textContent = `Score ${score} | Streak ${streak} | Progress: ${completedWords}/${totalWords}`;
  } catch (error) {
    console.error("Error in newRound:", error);
    const feedback = $("#feedback");
    if(feedback) feedback.textContent = "Game error occurred. Please refresh the page.";
  }
}

// Dynamic slot sizing for mobile devices
function adjustSlotSizeForMobile(wordLength) {
  if (window.innerWidth <= 480) {
    const availableWidth = window.innerWidth - 72; // Account for padding and margins (60 * 1.2)
    const gapWidth = 10 * (wordLength - 1); // 10px gap between slots (8 * 1.2)
    const slotWidth = Math.floor((availableWidth - gapWidth) / wordLength);
    
    // Ensure minimum and maximum slot sizes (increased by 20%)
    const finalSlotWidth = Math.max(34, Math.min(53, slotWidth)); // 28*1.2=34, 44*1.2=53
    const fontSize = Math.max(19, Math.min(34, finalSlotWidth * 0.6)); // 16*1.2=19, 28*1.2=34
    const gapSize = Math.max(5, Math.min(10, finalSlotWidth * 0.15)); // 4*1.2=5, 8*1.2=10
    
    // Calculate total word width to determine if centering is possible
    const totalWordWidth = (finalSlotWidth * wordLength) + (gapSize * (wordLength - 1));
    const needsScroll = totalWordWidth > availableWidth;
    
    // Apply custom styles
    const style = document.createElement('style');
    style.id = 'dynamic-slot-style';
    
    // Remove existing dynamic style if it exists
    const existingStyle = document.getElementById('dynamic-slot-style');
    if (existingStyle) {
      existingStyle.remove();
    }
    
    style.textContent = `
      @media (max-width: 480px) {
        .slot {
          width: ${finalSlotWidth}px !important;
          height: ${Math.max(43, finalSlotWidth * 1.2)}px !important;
          font-size: ${fontSize}px !important;
        }
        .mask {
          gap: ${gapSize}px !important;
          justify-content: ${needsScroll ? 'flex-start' : 'center'} !important;
          ${needsScroll ? 'padding-left: 12px !important;' : ''}
        }
        .puzzle-container {
          align-items: center !important;
        }
      }
    `;
    
    document.head.appendChild(style);
  }
}

function setupRound(word, missingIdxs, translation){
  elMask.innerHTML = "";
  elBank.innerHTML = "";
  elFeedback.textContent = "";
  elCat.textContent = "Dolch Sight Words";
  // Hide show answer button
  $("#showAnswer").style.display = "none";
  // Clear any previous answer display styles
  [...$$(".slot")].forEach(slot => {
    slot.style.backgroundColor = "";
    slot.style.border = "";
  });
  // Clear any used button states from previous round
  [...$$(".letters button")].forEach(btn => {
    btn.classList.remove("used");
  });
  
  // Show game controls and translation
  const gameControls = $("#gameControls");
  const wordTranslation = $("#wordTranslation");
  
  if(gameControls) gameControls.style.display = "flex";
  if(wordTranslation) {
    wordTranslation.style.display = "block";
    wordTranslation.textContent = translation || current.translation || "";
  }
  
  // Dynamic slot sizing for mobile
  adjustSlotSizeForMobile(word.length);
  
  const chars = [...word];
  const missingLetters = [];

  chars.forEach((ch, i)=>{
    const div = document.createElement("div");
    div.className = "slot" + (missingIdxs.has(i) ? " hole" : "");
    if(missingIdxs.has(i)){
      div.dataset.idx = i;
      div.textContent = "—";
      div.addEventListener("click", ()=>{
        if(div.dataset.filled){
          // 找到对应的按钮并重新启用
          const buttonId = div.dataset.buttonId;
          if(buttonId) {
            const correspondingBtn = [...$$(".letters button")].find(btn => btn.dataset.buttonId === buttonId);
            if(correspondingBtn) {
              correspondingBtn.classList.remove("used"); // 移除已使用状态，重新启用
            }
          }
          div.textContent = "—";
          div.dataset.filled = "";
          div.dataset.letter = "";
          div.dataset.buttonId = "";
        }
      });
      missingLetters.push(ch);
    } else {
      div.textContent = ch;
    }
    elMask.appendChild(div);
  });

  const distractors = makeDistractors(missingLetters, word);
  const bank = shuffle([...missingLetters, ...distractors]);
  bank.forEach(letter => addLetterToBank(letter));

  function addLetterToBank(letter){
    const btn = document.createElement("button");
    btn.textContent = letter.toLowerCase();
    btn.dataset.letter = letter.toLowerCase();
    btn.addEventListener("click", ()=>{
      if(btn.classList.contains("used")) return; // 已被使用的按钮不能再点击
      const hole = [...$$(".slot.hole")].find(s=>!s.dataset.filled);
      if(!hole) return;
      hole.textContent = letter.toLowerCase();
      hole.dataset.filled = "1";
      hole.dataset.letter = letter;
      hole.dataset.buttonId = btn.dataset.letter + "_" + Date.now(); // 添加唯一标识
      btn.dataset.buttonId = hole.dataset.buttonId; // 按钮也保存相同标识
      btn.classList.add("used"); // 添加已使用状态，变暗
      checkProgress();
    });
    elBank.appendChild(btn);
  }

  function checkProgress(){
    const filled = [...$$(".slot.hole")].every(s=>s.dataset.filled==="1");
    if(!filled) return;
    const guess = [...$$(".slot")].map(s=> (s.classList.contains("hole") ? (s.dataset.letter||"") : s.textContent)).join("").toLowerCase();
    const ok = guess === word.toLowerCase();
    if(ok){
      streak++; score += 10 + Math.max(0, (streak-1)*2);
      elFeedback.innerHTML = "✅ Great! The word is <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")";
      $("#next").classList.add("good");
      setTimeout(()=>{$("#next").classList.remove("good")},600);
      // Hide show answer button when correct
      $("#showAnswer").style.display = "none";
      
      // Show countdown and auto next question
      let countdown = 3;
      autoNextTimer = setInterval(()=>{
        countdown--;
        if(countdown > 0){
          elFeedback.innerHTML = "✅ Great! The word is <span class='bigword'>"+word.toLowerCase()+"</span> (" + (current.translation || "") + ")<br/>📍 " + countdown + " seconds until next question...";
        } else {
          clearInterval(autoNextTimer);
          autoNextTimer = null;
          newRound();
        }
      }, 1000);
    }else{
      streak=0; score = Math.max(0, score-2);
      elFeedback.innerHTML = "❌ Try again! Click slots to remove letters.";
      $("#replay").classList.add("bad");
      setTimeout(()=>{$("#replay").classList.remove("bad")},600);
      // Show answer button after wrong answer
      $("#showAnswer").style.display = "inline-block";
    }
    // Update status with progress information
    const totalWords = WORDS.length;
    const completedWords = usedWords.size;
    elStatus.textContent = `Score ${score} | Streak ${streak} | Progress: ${completedWords}/${totalWords}`;
  }
}

function makeMissingIndexes(len, n){
  const idxs = new Set();
  
  // Calculate available positions (exclude first and last for words > 2 letters)
  let availablePositions = [];
  if(len <= 2) {
    // For very short words, allow any position except keeping at least 1
    availablePositions = [...Array(len).keys()];
  } else {
    // For longer words, exclude first and last positions
    availablePositions = [...Array(len).keys()].slice(1, -1);
  }
  
  // Limit n to available positions to prevent infinite loop
  const maxPossible = Math.min(n, availablePositions.length, len - 1);
  
  // Shuffle available positions for random selection
  const shuffledPositions = shuffle([...availablePositions]);
  
  // Select the required number of positions
  for(let i = 0; i < maxPossible; i++) {
    idxs.add(shuffledPositions[i]);
  }
  
  return idxs;
}

function makeDistractors(missingLetters, word){
  const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
  const need = Math.max(3, missingLetters.length);
  const pool = new Set();
  
  // Add neighboring letters for confusion
  word.split("").forEach(ch=>{
    const i = alphabet.indexOf(ch.toLowerCase());
    if(i>0) pool.add(alphabet[i-1]);
    if(i<alphabet.length-1) pool.add(alphabet[i+1]);
  });
  
  // Add random letters with safety limit to prevent infinite loop
  let attempts = 0;
  const maxAttempts = 100; // Safety limit
  while(pool.size < Math.min(need*2, 20) && attempts < maxAttempts){
    pool.add(alphabet[Math.floor(Math.random()*alphabet.length)]);
    attempts++;
  }
  
  // Remove letters that are already in the missing letters
  missingLetters.forEach(ch=> pool.delete(ch.toLowerCase()));
  
  // Return the needed number of distractors
  return shuffle([...pool]).slice(0, need);
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

// Handle window resize for mobile optimization
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (current && current.word) {
      adjustSlotSizeForMobile(current.word.length);
    }
  }, 250);
});

// Start first question with error handling
setTimeout(() => {
  try {
    // Ensure DOM is ready and all elements are available
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => newRound());
    } else {
      newRound();
    }
  } catch (error) {
    console.error("Error starting game:", error);
    const feedback = $("#feedback");
    if(feedback) feedback.textContent = "Failed to start game. Please refresh the page.";
  }
}, 100);
</script>
</body>
</html>
